# =============================================================================
# CubeOS Releases Server — Nginx Configuration
# =============================================================================
# Stock Chainguard nginx with tuned large-file serving config.
# Serves release artifacts from /srv/cubeos-releases/data/ (bind-mounted).
#
# Deploy: copy to /srv/cubeos-releases/ on DMZ, restart container:
#   docker compose -f /srv/cubeos-releases/docker-compose.yml restart
# =============================================================================

worker_processes auto;
pid /tmp/nginx.pid;

events {
    worker_connections 256;
    use epoll;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Temp paths (Chainguard nginx runs as nonroot)
    client_body_temp_path /tmp/client_body;
    proxy_temp_path       /tmp/proxy;
    fastcgi_temp_path     /tmp/fastcgi;
    uwsgi_temp_path       /tmp/uwsgi;
    scgi_temp_path        /tmp/scgi;

    # Logging
    log_format main '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    'rt=$request_time';
    access_log /dev/stdout main;
    error_log  /dev/stderr warn;

    # ─── Performance: large-file optimizations ────────────────────────────────
    sendfile           on;
    sendfile_max_chunk 4m;        # Fair scheduling — no single request hogs I/O
    tcp_nopush         on;        # Coalesce headers + first data chunk
    tcp_nodelay        on;

    aio                threads;   # Non-blocking disk I/O via thread pool
    directio           4m;        # Bypass page cache for files >4MB (images)

    # ─── Bandwidth throttle ──────────────────────────────────────────────────
    limit_conn_zone $binary_remote_addr zone=addr:10m;

    # ─── Keepalive ───────────────────────────────────────────────────────────
    keepalive_timeout  65;
    keepalive_requests 100;

    # ─── Gzip (metadata only — images are already xz-compressed) ─────────────
    gzip            on;
    gzip_types      text/plain application/json text/css;
    gzip_min_length 256;

    # ─── Custom MIME types ───────────────────────────────────────────────────
    types {
        application/x-xz          xz;
        text/plain                 sha256;
    }

    server {
        listen 8080;
        server_name _;

        root /data;

        # ─── Per-connection limits ───────────────────────────────────────────
        limit_conn addr 3;                  # Max 3 connections per IP
        limit_rate_after 10m;               # Burst first 10MB at full speed
        limit_rate 2m;                      # Then throttle to 2MB/s

        # ─── CORS headers (browser downloads) ────────────────────────────────
        add_header Access-Control-Allow-Origin  "*" always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Range, Content-Type" always;
        add_header Access-Control-Expose-Headers "Content-Length, Content-Range, Accept-Ranges" always;

        # ─── Cache headers ───────────────────────────────────────────────────
        # Images are immutable (versioned paths), cache aggressively
        location ~* \.img\.xz$ {
            add_header Cache-Control "public, max-age=31536000, immutable" always;
            add_header Access-Control-Allow-Origin "*" always;
        }

        # JSON metadata — short cache
        location ~* \.json$ {
            add_header Cache-Control "public, max-age=300" always;
            add_header Access-Control-Allow-Origin "*" always;
        }

        # Checksums — medium cache
        location ~* \.sha256$ {
            add_header Cache-Control "public, max-age=3600" always;
            add_header Access-Control-Allow-Origin "*" always;
        }

        # ─── Directory listing ───────────────────────────────────────────────
        autoindex on;
        autoindex_exact_size off;           # Human-readable sizes
        autoindex_localtime on;

        # ─── Default location ────────────────────────────────────────────────
        location / {
            try_files $uri $uri/ =404;
        }

        # ─── Health check ────────────────────────────────────────────────────
        location = /health {
            return 200 "ok\n";
            add_header Content-Type text/plain;
        }
    }
}
