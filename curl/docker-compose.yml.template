# CubeOS Tier 2 — Docker Compose (curl installer)
# Generated by install.sh — do not edit directly.
# All services run as compose services (no Swarm stacks).
# Images pull from upstream registries (Docker Hub / GHCR).

name: cubeos

services:
  # ═══════════════════════════════════════════════════════════════════════════════
  # Local Docker Registry (port 5000)
  # Starts empty — API populates after first boot
  # ═══════════════════════════════════════════════════════════════════════════════
  registry:
    image: registry:2
    container_name: cubeos-registry
    hostname: cubeos-registry
    restart: unless-stopped
    ports:
      - "${REGISTRY_PORT}:5000"
    volumes:
      - /cubeos/data/registry:/var/lib/registry
    environment:
      - REGISTRY_HTTP_ADDR=0.0.0.0:5000
      - REGISTRY_STORAGE_DELETE_ENABLED=true
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:5000/v2/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    labels:
      - "cubeos.type=system"
      - "cubeos.category=infrastructure"
      - "cubeos.port=${REGISTRY_PORT}"
      - "cubeos.fqdn=registry.cubeos.cube"
      - "cubeos.deployment=compose"
      - "cubeos.description=Local Docker Registry"

  # ═══════════════════════════════════════════════════════════════════════════════
  # Pi-hole DNS (host network)
  # DHCP is always OFF in Tier 2 — CubeOS does not own the network.
  # DNS port is configurable for systemd-resolved coexistence.
  # ═══════════════════════════════════════════════════════════════════════════════
  pihole:
    image: pihole/pihole:latest
    container_name: cubeos-pihole
    hostname: cubeos-pihole
    restart: unless-stopped
    network_mode: host
    volumes:
      - /cubeos/coreapps/pihole/appdata/etc-pihole:/etc/pihole
    environment:
      - TZ=${TZ}
      # Web UI
      - FTLCONF_webserver_port=6001
      - FTLCONF_webserver_api_password=${PIHOLE_PASSWORD}
      # DNS core
      - FTLCONF_dns_port=${PIHOLE_DNS_PORT}
      - FTLCONF_dns_listeningMode=all
      - FTLCONF_dns_upstreams=1.1.1.1;8.8.8.8
      - FTLCONF_dns_dnssec=false
      # Local domain
      - FTLCONF_dns_domain_name=cubeos.cube
      - FTLCONF_dns_domain_local=true
      - FTLCONF_dns_domainNeeded=true
      - FTLCONF_dns_bogusPriv=true
      - FTLCONF_dns_expandHosts=false
      # DHCP — always OFF in Tier 2
      - FTLCONF_dhcp_active=false
      # Offline resilience
      - FTLCONF_dns_replyWhenBusy=ALLOW
      - FTLCONF_dns_blocking_active=false
    env_file:
      - /cubeos/config/defaults.env
    cap_add:
      - NET_ADMIN
      - NET_RAW
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1:6001/admin/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "cubeos.type=system"
      - "cubeos.category=infrastructure"
      - "cubeos.port=6001"
      - "cubeos.fqdn=pihole.cubeos.cube"
      - "cubeos.deployment=compose"
      - "cubeos.description=Pi-hole DNS Server"

  # ═══════════════════════════════════════════════════════════════════════════════
  # Nginx Proxy Manager (host network)
  # Ports: 80 (HTTP), 443 (HTTPS), 81 (Admin UI)
  # ═══════════════════════════════════════════════════════════════════════════════
  npm:
    image: jc21/nginx-proxy-manager:latest
    container_name: cubeos-npm
    hostname: cubeos-npm
    restart: unless-stopped
    network_mode: host
    volumes:
      - /cubeos/coreapps/npm/appdata/data:/data
      - /cubeos/coreapps/npm/appdata/letsencrypt:/etc/letsencrypt
    environment:
      - TZ=${TZ}
    env_file:
      - /cubeos/config/defaults.env
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1:81/api/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "cubeos.type=system"
      - "cubeos.category=infrastructure"
      - "cubeos.port=81"
      - "cubeos.fqdn=npm.cubeos.cube"
      - "cubeos.deployment=compose"
      - "cubeos.description=Nginx Proxy Manager"

  # ═══════════════════════════════════════════════════════════════════════════════
  # CubeOS HAL — Hardware Abstraction Layer (host network, privileged)
  # CUBEOS_TIER=container → returns 501 for network management endpoints
  # Device mounts are minimal for Tier 2 (x86 + ARM64 compatible)
  # ═══════════════════════════════════════════════════════════════════════════════
  cubeos-hal:
    image: ghcr.io/cubeos-app/hal:latest
    container_name: cubeos-hal
    restart: unless-stopped
    stop_grace_period: 15s
    network_mode: host
    pid: "host"
    privileged: true
    security_opt:
      - apparmor:unconfined
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_ADMIN
      - SYS_PTRACE
      - SYS_RAWIO
    volumes:
      # System access (universal)
      - /sys:/sys:rw
      - /proc:/proc:rw
      - /dev:/dev:rw
      # D-Bus (systemctl access)
      - /run/dbus/system_bus_socket:/run/dbus/system_bus_socket
      # Journal logs
      - /var/log/journal:/var/log/journal:ro
      - /run/log/journal:/run/log/journal:ro
      # HAL persistent data
      - /cubeos/coreapps/cubeos-hal/appdata:/data
      # Mount points
      - /cubeos/mounts:/cubeos/mounts
      # VPN configurations
      - /cubeos/config/vpn:/cubeos/config/vpn
      # Host OS identification
      - /etc/os-release:/host/etc/os-release:ro
    environment:
      - CUBEOS_TIER=container
      - HAL_PORT=6005
      - HAL_HOST=0.0.0.0
      - TZ=${TZ}
      - DBUS_SYSTEM_BUS_ADDRESS=unix:path=/run/dbus/system_bus_socket
      # UPS/Power — disabled by default in Tier 2
      - HAL_UPS_ENABLED=false
      - HAL_POWER_MONITOR_AUTOSTART=false
      # Hardware features (autodetected)
      - HAL_I2C_BUS=1
    env_file:
      - /cubeos/config/defaults.env
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:6005/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    labels:
      - "cubeos.type=system"
      - "cubeos.port=6005"
      - "cubeos.deployment=compose"
      - "cubeos.description=Hardware Abstraction Layer"

  # ═══════════════════════════════════════════════════════════════════════════════
  # CubeOS API Server (port 6010)
  # HAL_URL points to host IP (HAL is on host network)
  # ═══════════════════════════════════════════════════════════════════════════════
  cubeos-api:
    image: ghcr.io/cubeos-app/api:latest
    container_name: cubeos-api
    hostname: cubeos-api
    restart: unless-stopped
    ports:
      - "${API_PORT}:6010"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /cubeos:/cubeos
      - /sys:/sys:ro
      - /proc:/proc:ro
    environment:
      - TZ=${TZ}
      - CUBEOS_PORT=6010
      - CUBEOS_TIER=container
      - CUBEOS_DATA_DIR=/cubeos/data
      - CUBEOS_DB_PATH=/cubeos/data/cubeos.db
      - HAL_URL=http://${GATEWAY_IP}:6005/hal
    env_file:
      - /cubeos/config/defaults.env
      - /cubeos/config/secrets.env
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:6010/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    labels:
      - "cubeos.type=platform"
      - "cubeos.category=platform"
      - "cubeos.port=${API_PORT}"
      - "cubeos.fqdn=api.cubeos.cube"
      - "cubeos.deployment=compose"
      - "cubeos.description=CubeOS API Server"

  # ═══════════════════════════════════════════════════════════════════════════════
  # CubeOS Dashboard (port 6011)
  # Internal port is 8087, published as configured
  # ═══════════════════════════════════════════════════════════════════════════════
  cubeos-dashboard:
    image: ghcr.io/cubeos-app/dashboard:latest
    container_name: cubeos-dashboard
    hostname: cubeos-dashboard
    restart: unless-stopped
    ports:
      - "${DASHBOARD_PORT}:8087"
    environment:
      - TZ=${TZ}
      - API_URL=http://${GATEWAY_IP}:${API_PORT}
    env_file:
      - /cubeos/config/defaults.env
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 32M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:8087/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    labels:
      - "cubeos.type=platform"
      - "cubeos.category=platform"
      - "cubeos.port=${DASHBOARD_PORT}"
      - "cubeos.fqdn=cubeos.cube"
      - "cubeos.deployment=compose"
      - "cubeos.description=CubeOS Dashboard"

  # ═══════════════════════════════════════════════════════════════════════════════
  # Dozzle — Container Log Viewer (port 6012)
  # Internal port is 8080, published as configured
  # ═══════════════════════════════════════════════════════════════════════════════
  dozzle:
    image: amir20/dozzle:latest
    container_name: cubeos-dozzle
    hostname: cubeos-dozzle
    restart: unless-stopped
    ports:
      - "${DOZZLE_PORT}:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - TZ=${TZ}
      - DOZZLE_LEVEL=info
      - DOZZLE_TAILSIZE=300
      - DOZZLE_NO_ANALYTICS=true
    env_file:
      - /cubeos/config/defaults.env
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 48M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:8080/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    labels:
      - "cubeos.type=platform"
      - "cubeos.category=monitoring"
      - "cubeos.port=${DOZZLE_PORT}"
      - "cubeos.fqdn=dozzle.cubeos.cube"
      - "cubeos.deployment=compose"
      - "cubeos.description=Dozzle - Container log viewer"

  # ═══════════════════════════════════════════════════════════════════════════════
  # CubeOS Document Indexer (port 6032)
  # Filesystem mode — no Ollama/ChromaDB dependency
  # ═══════════════════════════════════════════════════════════════════════════════
  cubeos-docsindex:
    image: ghcr.io/cubeos-app/cubeos-docsindex:latest
    container_name: cubeos-docsindex
    hostname: cubeos-docsindex
    restart: unless-stopped
    ports:
      - "${DOCSINDEX_PORT}:8080"
    volumes:
      - /cubeos/docs:/cubeos/docs
    environment:
      - TZ=${TZ}
      - LISTEN_ADDR=:8080
      - DOCS_LOCAL_PATH=/cubeos/docs
      - OLLAMA_HOST=
      - OLLAMA_PORT=
      - CHROMADB_HOST=
      - CHROMADB_PORT=
    env_file:
      - /cubeos/config/defaults.env
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    labels:
      - "cubeos.type=ai"
      - "cubeos.category=ai"
      - "cubeos.port=${DOCSINDEX_PORT}"
      - "cubeos.fqdn=docs.cubeos.cube"
      - "cubeos.deployment=compose"
      - "cubeos.description=CubeOS Document Indexer"
