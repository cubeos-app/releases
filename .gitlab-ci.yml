# =============================================================================
# CubeOS Release Image Pipeline
# =============================================================================
# Builds a flashable ARM64 image from the pre-built golden base image.
#
# ARCHITECTURE:
#   Golden base image is built EXTERNALLY on nllei01gpu01 using the
#   cubeos-base-builder tooling and uploaded to GitLab Package Registry.
#   This pipeline only does configuration, Docker image preloading, and
#   compression — no apt-get, no heavy QEMU package installs.
#
# STAGES:
#   1. download — Fetch ARM64 Docker images via skopeo (x86_64 native)
#   2. build    — Packer: apply configs to golden base, bake in images, compress
#
# PREREQUISITES:
#   1. Golden base image in Package Registry (built by /srv/cubeos-base-builder
#      on nllei01gpu01 — see base-image/README.md)
#   2. CI variables: GHCR_USER, GHCR_TOKEN (for private GHCR images)
#
# TIME: ~5-10 minutes total (no package downloads)
# =============================================================================

stages:
  - download
  - build

variables:
  CUBEOS_VERSION: "0.1.0-alpha"
  IMAGE_NAME: "cubeos-${CUBEOS_VERSION}-arm64"
  BASE_VERSION: "1.0.0"
  BASE_IMAGE_NAME: "cubeos-base-ubuntu24.04.3-arm64"

# =============================================================================
# Stage 1: Download Docker Images (ARM64 via skopeo)
# =============================================================================
# Skopeo runs natively on x86_64 and fetches ARM64 manifests directly.
# No QEMU needed. Outputs tarballs passed to the build stage as artifacts.
# =============================================================================
download-docker-images:
  stage: download
  image:
    name: quay.io/skopeo/stable:latest
    entrypoint: [""]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_COMMIT_TAG =~ /^v/'
  before_script:
    - |
      if [ -z "${GHCR_USER:-}" ] || [ -z "${GHCR_TOKEN:-}" ]; then
        echo "ERROR: GHCR_USER and GHCR_TOKEN CI variables are required."
        echo "Set them in: Settings > CI/CD > Variables"
        exit 1
      fi
      echo "GHCR auth: ${GHCR_USER}"
  script:
    - mkdir -p docker-images
    - echo "=== Downloading ARM64 Docker images ==="

    - echo "[1/5] Pi-hole..."
    - skopeo copy --override-arch arm64 --override-os linux --retry-times 3 docker://docker.io/pihole/pihole:latest docker-archive:docker-images/pihole.tar:pihole/pihole:latest

    - echo "[2/5] Nginx Proxy Manager..."
    - skopeo copy --override-arch arm64 --override-os linux --retry-times 3 docker://docker.io/jc21/nginx-proxy-manager:latest docker-archive:docker-images/npm.tar:jc21/nginx-proxy-manager:latest

    - echo "[3/5] CubeOS API..."
    - skopeo copy --src-creds "${GHCR_USER}:${GHCR_TOKEN}" --override-arch arm64 --override-os linux --retry-times 3 docker://ghcr.io/cubeos-app/api:latest docker-archive:docker-images/cubeos-api.tar:ghcr.io/cubeos-app/api:latest

    - echo "[4/5] CubeOS HAL..."
    - skopeo copy --src-creds "${GHCR_USER}:${GHCR_TOKEN}" --override-arch arm64 --override-os linux --retry-times 3 docker://ghcr.io/cubeos-app/hal:latest docker-archive:docker-images/cubeos-hal.tar:ghcr.io/cubeos-app/hal:latest

    - echo "[5/5] CubeOS Dashboard..."
    - skopeo copy --src-creds "${GHCR_USER}:${GHCR_TOKEN}" --override-arch arm64 --override-os linux --retry-times 3 docker://ghcr.io/cubeos-app/dashboard:latest docker-archive:docker-images/cubeos-dashboard.tar:ghcr.io/cubeos-app/dashboard:latest

    - echo ""
    - echo "=== Download complete ==="
    - ls -lh docker-images/
    - du -sh docker-images/
  artifacts:
    paths:
      - docker-images/
    expire_in: 4 hours

# =============================================================================
# Stage 2: Build Release Image
# =============================================================================
# Downloads golden base from Package Registry, runs config-only Packer
# provisioners (Netplan, hostapd, CubeOS dirs, firstboot scripts, Docker
# image tarballs), then shrinks and compresses the final image.
#
# Time: ~5 minutes (no apt-get, no package downloads)
# =============================================================================
build-image:
  stage: build
  image:
    name: mkaczanowski/packer-builder-arm:latest
    entrypoint: [""]
  needs:
    - download-docker-images
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_COMMIT_TAG =~ /^v/'
  before_script:
    - mount binfmt_misc -t binfmt_misc /proc/sys/fs/binfmt_misc || true
    - |
      if [ ! -f /proc/sys/fs/binfmt_misc/qemu-aarch64 ]; then
        echo "ERROR: QEMU aarch64 binfmt not registered on host!"
        echo "Fix: docker run --rm --privileged multiarch/qemu-user-static --reset -p yes"
        exit 1
      fi
      echo "QEMU aarch64 binfmt: OK"

    # Install tools for compression
    - apt-get update -q
    - apt-get install -y -q xz-utils zerofree e2fsprogs parted wget kpartx util-linux curl 2>&1 | tail -5

    # Download golden base image from Package Registry
    - echo "Downloading golden base image from Package Registry..."
    - |
      curl --fail --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           -o cubeos-base.img.xz \
           --connect-timeout 30 \
           --max-time 600 \
           --retry 3 \
           --retry-delay 10 \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cubeos-base/${BASE_VERSION}/${BASE_IMAGE_NAME}.img.xz"
    - ls -lh cubeos-base.img.xz
    - echo "Base image downloaded."
  script:
    # =====================================================================
    # Phase 1: Packer build (config only — packages already in base)
    # =====================================================================
    - echo "=== Building CubeOS ${CUBEOS_VERSION} from golden base ==="
    - chmod +x packer/scripts/*.sh firstboot/*.sh

    # Packer uses local base image
    - |
      packer build \
        -var "version=${CUBEOS_VERSION}" \
        -var "base_image_url=file://${CI_PROJECT_DIR}/cubeos-base.img.xz" \
        -var "base_image_checksum_type=none" \
        packer/cubeos.pkr.hcl
    - ls -lh ${IMAGE_NAME}.img
    - echo "=== Packer build complete ==="
    - echo ""

    # =====================================================================
    # Phase 2: Shrink + Compress
    # =====================================================================
    - echo "=== Compressing ${IMAGE_NAME}.img ==="

    # PiShrink (skip auto-expand — cloud-init growpart handles it)
    - echo "[1/4] Running PiShrink..."
    - wget -q -O pishrink.sh https://raw.githubusercontent.com/Drewsif/PiShrink/master/pishrink.sh || echo "WARN PiShrink download failed, skipping"
    - |
      if [ -f pishrink.sh ]; then
        chmod +x pishrink.sh
        bash pishrink.sh -s ${IMAGE_NAME}.img || echo "WARN PiShrink failed (non-fatal)"
      fi

    # Zerofree (improves xz compression ratio significantly)
    - echo "[2/4] Running zerofree..."
    - |
      LOOPDEV=""
      cleanup_loop() {
        if [ -n "$LOOPDEV" ]; then
          losetup -d "$LOOPDEV" 2>/dev/null || true
        fi
      }
      trap cleanup_loop EXIT
      LOOPDEV=$(losetup -fP --show ${IMAGE_NAME}.img)
      echo "Loop device: $LOOPDEV"
      sleep 2
      ROOT_PART="${LOOPDEV}p2"
      if [ -b "$ROOT_PART" ]; then
        e2fsck -fy "$ROOT_PART" || true
        zerofree -v "$ROOT_PART" || echo "WARN zerofree failed (non-fatal)"
      fi
      losetup -d "$LOOPDEV"
      LOOPDEV=""

    # XZ compress
    - echo "[3/4] Compressing with xz -6 (multi-threaded)..."
    - ls -lh ${IMAGE_NAME}.img
    - xz -6 -T0 -v ${IMAGE_NAME}.img

    # Checksums
    - echo "[4/4] Calculating checksums..."
    - sha256sum ${IMAGE_NAME}.img.xz > ${IMAGE_NAME}.img.xz.sha256
    - md5sum ${IMAGE_NAME}.img.xz > ${IMAGE_NAME}.img.xz.md5

    # Summary
    - echo ""
    - echo "============================================================"
    - echo "  CubeOS Release Artifact"
    - echo "============================================================"
    - echo "  Version  ${CUBEOS_VERSION}"
    - echo "  File     ${IMAGE_NAME}.img.xz"
    - echo "  Size     $(du -h ${IMAGE_NAME}.img.xz | cut -f1)"
    - echo "  SHA256   $(cut -d' ' -f1 ${IMAGE_NAME}.img.xz.sha256)"
    - echo "  Base     cubeos-base/${BASE_VERSION}"
    - echo "============================================================"
  artifacts:
    paths:
      - "${IMAGE_NAME}.img.xz"
      - "${IMAGE_NAME}.img.xz.sha256"
      - "${IMAGE_NAME}.img.xz.md5"
    expire_in: 30 days
  timeout: 60m

# =============================================================================
# Optional: Create GitLab Release (triggered by tag push only)
# =============================================================================
create-release:
  stage: .post
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - build-image
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v/'
  script:
    - echo "Creating release for ${CI_COMMIT_TAG}..."
    - CHECKSUM=$(cut -d' ' -f1 ${IMAGE_NAME}.img.xz.sha256)
    - echo "SHA256 ${CHECKSUM}"
  release:
    tag_name: "${CI_COMMIT_TAG}"
    name: "CubeOS ${CI_COMMIT_TAG}"
    description: |
      ## CubeOS ${CI_COMMIT_TAG}

      Flashable ARM64 image for Raspberry Pi 4/5 (Ubuntu 24.04.3 based).

      ### Quick Start
      1. Flash the .img.xz to SD card using Raspberry Pi Imager
      2. Boot the Pi
      3. Connect to WiFi AP (check console output for SSID and password)
      4. Open http://cubeos.cube in your browser
      5. Complete the setup wizard

      ### Default Credentials
      - Dashboard: admin / cubeos
      - SSH: key-only (configure in wizard)
    assets:
      links:
        - name: "${IMAGE_NAME}.img.xz"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cubeos/${CUBEOS_VERSION}/${IMAGE_NAME}.img.xz"
        - name: "SHA256 Checksum"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cubeos/${CUBEOS_VERSION}/${IMAGE_NAME}.img.xz.sha256"
