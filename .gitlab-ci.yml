# =============================================================================
# CubeOS Release Image Pipeline
# =============================================================================
# Builds a flashable ARM64 SD card image for Raspberry Pi 4/5.
#
# Stages:
#   1. download — Fetch ARM64 Docker images via skopeo (native x86 speed)
#   2. build    — Packer builds the image under QEMU ARM64 emulation
#   3. compress — PiShrink + zerofree + xz compression + checksums
#
# Triggers:
#   - Manual trigger from GitLab UI (default)
#   - Push to tag matching v*
#
# Runner requirements:
#   - Self-hosted runner with privileged Docker executor
#   - Tag: "privileged" or "image-builder"
#   - qemu-user-static registered on host (binfmt_misc)
# =============================================================================

stages:
  - download
  - build
  - compress

variables:
  CUBEOS_VERSION: "0.1.0-alpha"
  IMAGE_NAME: "cubeos-${CUBEOS_VERSION}-arm64"
  # Pi OS Lite Bookworm ARM64 base image
  BASE_IMAGE_URL: "https://downloads.raspberrypi.com/raspios_lite_arm64/images/raspios_lite_arm64-2024-11-19/2024-11-19-raspios-bookworm-arm64-lite.img.xz"
  BASE_IMAGE_CHECKSUM_URL: "https://downloads.raspberrypi.com/raspios_lite_arm64/images/raspios_lite_arm64-2024-11-19/2024-11-19-raspios-bookworm-arm64-lite.img.xz.sha256"

# =============================================================================
# Stage 1: Download ARM64 Docker images at native x86 speed
# =============================================================================
download-docker-images:
  stage: download
  image: quay.io/skopeo/stable:latest

  script:
    - mkdir -p docker-images

    # CubeOS core images (ARM64)
    - echo "Downloading Pi-hole..."
    - skopeo copy --override-arch arm64 --override-os linux
        docker://docker.io/pihole/pihole:latest
        docker-archive:docker-images/pihole.tar:pihole/pihole:latest

    - echo "Downloading NPM..."
    - skopeo copy --override-arch arm64 --override-os linux
        docker://docker.io/jc21/nginx-proxy-manager:latest
        docker-archive:docker-images/npm.tar:jc21/nginx-proxy-manager:latest

    - echo "Downloading CubeOS API..."
    - skopeo copy --override-arch arm64 --override-os linux
        docker://ghcr.io/cubeos-app/cubeos-api:latest
        docker-archive:docker-images/cubeos-api.tar:ghcr.io/cubeos-app/cubeos-api:latest

    - echo "Downloading CubeOS HAL..."
    - skopeo copy --override-arch arm64 --override-os linux
        docker://ghcr.io/cubeos-app/cubeos-hal:latest
        docker-archive:docker-images/cubeos-hal.tar:ghcr.io/cubeos-app/cubeos-hal:latest

    - echo "Downloading CubeOS Dashboard..."
    - skopeo copy --override-arch arm64 --override-os linux
        docker://ghcr.io/cubeos-app/cubeos-dashboard:latest
        docker-archive:docker-images/cubeos-dashboard.tar:ghcr.io/cubeos-app/cubeos-dashboard:latest

    - echo "Download summary:"
    - ls -lh docker-images/
    - du -sh docker-images/

  artifacts:
    paths:
      - docker-images/
    expire_in: 4 hours

# =============================================================================
# Stage 2: Build image with Packer under QEMU emulation
# =============================================================================
build-image:
  stage: build
  image:
    name: mkaczanowski/packer-builder-arm:latest
    entrypoint: [""]

  needs:
    - download-docker-images
  before_script:
    # Register QEMU binfmt handlers (in case not registered on host)
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes 2>/dev/null || true
  script:
    - echo "Building CubeOS ${CUBEOS_VERSION} image..."
    - echo "Base image - ${BASE_IMAGE_URL}"

    # Make provisioning scripts executable
    - chmod +x packer/scripts/*.sh
    - chmod +x firstboot/*.sh

    # Build the image
    - packer build
        -var "version=${CUBEOS_VERSION}"
        -var "base_image_url=${BASE_IMAGE_URL}"
        -var "base_image_checksum=${BASE_IMAGE_CHECKSUM_URL}"
        packer/cubeos.pkr.hcl

    - echo "Image built:"
    - ls -lh ${IMAGE_NAME}.img

  artifacts:
    paths:
      - "${IMAGE_NAME}.img"
    expire_in: 4 hours

# =============================================================================
# Stage 3: Shrink, zero, compress, checksum
# =============================================================================
compress-image:
  stage: compress
  image: ubuntu:24.04

  needs:
    - build-image
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq xz-utils e2fsprogs zerofree parted wget kpartx
    # Install PiShrink
    - wget -q https://raw.githubusercontent.com/Drewsif/PiShrink/master/pishrink.sh
    - chmod +x pishrink.sh
  script:
    - echo "Compressing ${IMAGE_NAME}.img..."

    # Step 1: PiShrink — shrink partition to minimum, enable auto-expand on boot
    - echo "Running PiShrink..."
    - ./pishrink.sh -s ${IMAGE_NAME}.img || true

    # Step 2: Zerofree — zero unused blocks for better compression
    - echo "Running zerofree..."
    - |
      LOOPDEV=$(losetup -fP --show ${IMAGE_NAME}.img)
      # Find the root partition (partition 2)
      ROOT_PART="${LOOPDEV}p2"
      if [ -b "$ROOT_PART" ]; then
        e2fsck -fy "$ROOT_PART" || true
        zerofree "$ROOT_PART" || true
      fi
      losetup -d "$LOOPDEV"

    # Step 3: XZ compress
    - echo "Compressing with xz (this takes 5-10 minutes)..."
    - xz -6 -T0 -v ${IMAGE_NAME}.img

    # Step 4: Checksums
    - echo "Calculating checksums..."
    - sha256sum ${IMAGE_NAME}.img.xz > ${IMAGE_NAME}.img.xz.sha256
    - md5sum ${IMAGE_NAME}.img.xz > ${IMAGE_NAME}.img.xz.md5

    # Summary
    - echo ""
    - echo "============================================================"
    - echo "  CubeOS Release Artifact"
    - echo "============================================================"
    - echo "  File    - ${IMAGE_NAME}.img.xz"
    - echo "  Size    - $(du -h ${IMAGE_NAME}.img.xz | cut -f1)"
    - echo "  SHA256  - $(cat ${IMAGE_NAME}.img.xz.sha256 | cut -d' ' -f1)"
    - echo "============================================================"

  artifacts:
    paths:
      - "${IMAGE_NAME}.img.xz"
      - "${IMAGE_NAME}.img.xz.sha256"
      - "${IMAGE_NAME}.img.xz.md5"
    expire_in: 30 days

# =============================================================================
# Optional: Create GitLab Release (on tag push only)
# =============================================================================
create-release:
  stage: .post
  image: registry.gitlab.com/gitlab-org/release-cli:latest

  needs:
    - compress-image
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v/'
  script:
    - echo "Creating release for ${CI_COMMIT_TAG}..."
  release:
    tag_name: "${CI_COMMIT_TAG}"
    name: "CubeOS ${CI_COMMIT_TAG}"
    description: |
      ## CubeOS ${CI_COMMIT_TAG}

      Flashable ARM64 image for Raspberry Pi 4/5.

      ### Quick Start
      1. Flash `${IMAGE_NAME}.img.xz` to SD card using Raspberry Pi Imager
      2. Boot the Pi
      3. Connect to WiFi AP: `CubeOS-XXXXXX` (check console for password)
      4. Open http://cubeos.cube in your browser
      5. Complete the setup wizard

      ### Default Credentials
      - Dashboard: admin / cubeos
      - SSH: key-only (configure in wizard)

      ### Checksums
      ```
      SHA256: $(cat ${IMAGE_NAME}.img.xz.sha256 | cut -d' ' -f1)
      ```
    assets:
      links:
        - name: "${IMAGE_NAME}.img.xz"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cubeos/${CUBEOS_VERSION}/${IMAGE_NAME}.img.xz"
        - name: "SHA256 Checksum"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cubeos/${CUBEOS_VERSION}/${IMAGE_NAME}.img.xz.sha256"
