# CubeOS Release Pipeline
# Builds SD card images for Raspberry Pi 5
#
# HOW TO USE:
# -----------
# Option 1: Manual trigger
#   1. Go to GitLab → CI/CD → Pipelines
#   2. Click "Run pipeline"
#   3. Set VERSION variable (e.g., "0.1.0")
#
# Option 2: Create a git tag
#   git tag -a v0.1.0 -m "Release 0.1.0"
#   git push origin v0.1.0

stages:
  - prepare
  - build
  - compress
  - release

variables:
  VERSION: "0.1.0-dev"
  IMAGE_NAME: "cubeos-${VERSION}-pi5"
  UBUNTU_IMAGE_URL: "https://cdimage.ubuntu.com/releases/24.04/release/ubuntu-24.04.1-preinstalled-server-arm64+raspi.img.xz"

workflow:
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+/
      variables:
        VERSION: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "web"
    - when: never

setup-qemu:
  stage: prepare
  image: docker:24-cli
  tags:
    - multiarch
  services:
    - docker:24-dind
  script:
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

build-image:
  stage: build
  image: mkaczanowski/packer-builder-arm:latest
  tags:
    - multiarch
  needs:
    - setup-qemu
  before_script:
    - mkdir -p files/coreapps files/scripts
    - git clone --depth 1 https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.nuclearlighters.net/products/cubeos/coreapps.git /tmp/coreapps || true
    - cp -r /tmp/coreapps/*/ files/coreapps/ 2>/dev/null || true
    - cp /tmp/coreapps/*.sh files/coreapps/ 2>/dev/null || true
    - git clone --depth 1 https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.nuclearlighters.net/products/cubeos/scripts.git /tmp/scripts || true
    - cp /tmp/scripts/*.sh files/scripts/ 2>/dev/null || true
  script:
    - packer init cubeos.pkr.hcl
    - packer build -var "cubeos_version=${VERSION}" -var "ubuntu_image_url=${UBUNTU_IMAGE_URL}" cubeos.pkr.hcl
    - mv output-cubeos/image "${IMAGE_NAME}.img"
    - ls -lh "${IMAGE_NAME}.img"
  artifacts:
    paths:
      - "*.img"
    expire_in: 2 hours
  timeout: 2 hours

shrink-image:
  stage: compress
  image: debian:bookworm
  tags:
    - multiarch
  needs:
    - build-image
  before_script:
    - apt-get update && apt-get install -y wget parted e2fsprogs xz-utils
    - wget -q https://raw.githubusercontent.com/Drewsif/PiShrink/master/pishrink.sh -O /usr/local/bin/pishrink
    - chmod +x /usr/local/bin/pishrink
  script:
    - /usr/local/bin/pishrink -s "${IMAGE_NAME}.img" || true
    - xz -T0 -6 -v "${IMAGE_NAME}.img"
    - sha256sum "${IMAGE_NAME}.img.xz" > "${IMAGE_NAME}.img.xz.sha256"
    - ls -lh "${IMAGE_NAME}.img.xz"
  artifacts:
    paths:
      - "*.img.xz"
      - "*.sha256"
    expire_in: 1 week
  timeout: 1 hour

release-github:
  stage: release
  image: alpine:latest
  tags:
    - multiarch
  needs:
    - shrink-image
  before_script:
    - apk add --no-cache curl github-cli
  script:
    - echo "${GHCR_TOKEN}" | gh auth login --with-token
    - echo "Creating release ${VERSION}..."
    - gh release create "${VERSION}" --repo cubeos-app/releases --title "CubeOS ${VERSION}" --notes "CubeOS ${VERSION} for Raspberry Pi 5" "${IMAGE_NAME}.img.xz" "${IMAGE_NAME}.img.xz.sha256" || true
    - gh release upload "${VERSION}" --repo cubeos-app/releases --clobber "${IMAGE_NAME}.img.xz" "${IMAGE_NAME}.img.xz.sha256" || true
    - echo "Done - https://github.com/cubeos-app/releases/releases/tag/${VERSION}"

update-manifest:
  stage: release
  image: alpine:latest
  tags:
    - multiarch
  needs:
    - shrink-image
  script:
    - apk add --no-cache coreutils
    - SIZE=$(stat -c%s "${IMAGE_NAME}.img.xz")
    - SHA256=$(cat "${IMAGE_NAME}.img.xz.sha256" | cut -d' ' -f1)
    - DATE=$(date +%Y-%m-%d)
    - echo "{\"os_list\":[{\"name\":\"CubeOS ${VERSION}\",\"description\":\"CubeOS for Raspberry Pi 5\",\"url\":\"https://github.com/cubeos-app/releases/releases/download/${VERSION}/${IMAGE_NAME}.img.xz\",\"extract_sha256\":\"${SHA256}\",\"image_download_size\":${SIZE},\"release_date\":\"${DATE}\",\"init_format\":\"cloudinit\",\"devices\":[\"pi5-64bit\",\"pi4-64bit\"]}]}" > os_list.json
    - cat os_list.json
  artifacts:
    paths:
      - os_list.json
    expire_in: 1 week
  allow_failure: true
