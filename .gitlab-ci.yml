# =============================================================================
# CubeOS Release Image Pipeline
# =============================================================================
# Two-tier build system for fast, reproducible image creation:
#
# TIER 1 — Golden Base Image (run manually, ~20 min):
#   Takes stock Ubuntu 24.04.3 Server → installs all packages → stores in
#   GitLab Package Registry. Run monthly or when package list changes.
#   Trigger: Manual, or push changes to base-image/ directory.
#
# TIER 2 — Release Image (run on push, ~5 min):
#   Takes golden base image → adds CubeOS config, compose files, firstboot
#   scripts, Docker image tarballs → compresses → release artifact.
#   No apt-get, no package downloads.
#
# FIRST-TIME SETUP:
#   1. Run "build-base-image" job manually (Pipeline → Run → base stage)
#   2. After base image is in registry, release pipeline works automatically
#
# Required CI variables:
#   - GHCR_USER  — GitHub username for GHCR
#   - GHCR_TOKEN — GitHub PAT with read:packages scope
# =============================================================================

stages:
  - base
  - download
  - build

variables:
  CUBEOS_VERSION: "0.1.0-alpha"
  IMAGE_NAME: "cubeos-${CUBEOS_VERSION}-arm64"
  BASE_VERSION: "1.0.0"
  BASE_IMAGE_NAME: "cubeos-base-ubuntu24.04.3-arm64"

# =============================================================================
# TIER 1: Golden Base Image
# =============================================================================
# Builds Ubuntu 24.04.3 + all system packages into a reusable base image.
# Stored in GitLab's Generic Package Registry for the release pipeline.
#
# Trigger: Manual only (or uncomment rules for path-based auto-trigger)
# Time: ~20 minutes (QEMU emulation for apt-get)
# Output: cubeos-base-ubuntu24.04.3-arm64.img.xz in Package Registry
# =============================================================================
build-base-image:
  stage: base
  image:
    name: mkaczanowski/packer-builder-arm:latest
    entrypoint: [""]
  rules:
    # Always available as manual trigger
    - when: manual
      allow_failure: true
    # Uncomment to auto-trigger on base-image/ changes:
    # - changes:
    #     - base-image/**/*
  before_script:
    - mount binfmt_misc -t binfmt_misc /proc/sys/fs/binfmt_misc || true
    - |
      if [ ! -f /proc/sys/fs/binfmt_misc/qemu-aarch64 ]; then
        echo "ERROR: QEMU aarch64 binfmt not registered on host!"
        echo "Fix: docker run --rm --privileged multiarch/qemu-user-static --reset -p yes"
        exit 1
      fi
      echo "QEMU aarch64 binfmt: OK"
    # Install compression tools
    - apt-get update -qq
    - apt-get install -y -qq xz-utils curl 2>&1 | tail -1
  script:
    - |
      echo "=== Building Golden Base Image ==="
      chmod +x base-image/scripts/*.sh

      # Build base image with Packer
      packer build base-image/cubeos-base.pkr.hcl
      ls -lh ${BASE_IMAGE_NAME}.img

      # Compress
      echo "Compressing base image..."
      xz -6 -T0 -v ${BASE_IMAGE_NAME}.img
      ls -lh ${BASE_IMAGE_NAME}.img.xz

      # Calculate checksum
      sha256sum ${BASE_IMAGE_NAME}.img.xz > ${BASE_IMAGE_NAME}.img.xz.sha256
      echo "SHA256: $(cat ${BASE_IMAGE_NAME}.img.xz.sha256)"

      # Upload to GitLab Generic Package Registry
      echo "Uploading to Package Registry..."
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file ${BASE_IMAGE_NAME}.img.xz \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cubeos-base/${BASE_VERSION}/${BASE_IMAGE_NAME}.img.xz"

      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file ${BASE_IMAGE_NAME}.img.xz.sha256 \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cubeos-base/${BASE_VERSION}/${BASE_IMAGE_NAME}.img.xz.sha256"

      echo ""
      echo "============================================================"
      echo "  Golden Base Image uploaded to Package Registry"
      echo "  Package: cubeos-base/${BASE_VERSION}"
      echo "  File:    ${BASE_IMAGE_NAME}.img.xz"
      echo "  Size:    $(du -h ${BASE_IMAGE_NAME}.img.xz | cut -f1)"
      echo "============================================================"
  timeout: 45m

# =============================================================================
# TIER 2: Release Image — Stage 1: Download Docker Images
# =============================================================================
download-docker-images:
  stage: download
  image:
    name: quay.io/skopeo/stable:latest
    entrypoint: [""]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_COMMIT_TAG =~ /^v/'
  before_script:
    - |
      if [ -z "${GHCR_USER}" ] || [ -z "${GHCR_TOKEN}" ]; then
        echo "ERROR: GHCR_USER and GHCR_TOKEN CI variables are required."
        exit 1
      fi
      echo "GHCR auth: ${GHCR_USER}"
  script:
    - mkdir -p docker-images
    - echo "=== Downloading ARM64 Docker images ==="

    - echo "[1/5] Pi-hole..."
    - skopeo copy --override-arch arm64 --override-os linux --retry-times 3 docker://docker.io/pihole/pihole:latest docker-archive:docker-images/pihole.tar:pihole/pihole:latest

    - echo "[2/5] Nginx Proxy Manager..."
    - skopeo copy --override-arch arm64 --override-os linux --retry-times 3 docker://docker.io/jc21/nginx-proxy-manager:latest docker-archive:docker-images/npm.tar:jc21/nginx-proxy-manager:latest

    - echo "[3/5] CubeOS API..."
    - skopeo copy --src-creds "${GHCR_USER}:${GHCR_TOKEN}" --override-arch arm64 --override-os linux --retry-times 3 docker://ghcr.io/cubeos-app/api:latest docker-archive:docker-images/cubeos-api.tar:ghcr.io/cubeos-app/api:latest

    - echo "[4/5] CubeOS HAL..."
    - skopeo copy --src-creds "${GHCR_USER}:${GHCR_TOKEN}" --override-arch arm64 --override-os linux --retry-times 3 docker://ghcr.io/cubeos-app/hal:latest docker-archive:docker-images/cubeos-hal.tar:ghcr.io/cubeos-app/hal:latest

    - echo "[5/5] CubeOS Dashboard..."
    - skopeo copy --src-creds "${GHCR_USER}:${GHCR_TOKEN}" --override-arch arm64 --override-os linux --retry-times 3 docker://ghcr.io/cubeos-app/dashboard:latest docker-archive:docker-images/cubeos-dashboard.tar:ghcr.io/cubeos-app/dashboard:latest

    - echo ""
    - echo "=== Download complete ==="
    - ls -lh docker-images/
    - du -sh docker-images/
  artifacts:
    paths:
      - docker-images/
    expire_in: 4 hours

# =============================================================================
# TIER 2: Release Image — Stage 2: Build + Compress
# =============================================================================
# Downloads golden base from Package Registry, runs config-only provisioners,
# bakes in Docker image tarballs, compresses final image.
# Time: ~5 minutes (no apt-get, no package downloads)
# =============================================================================
build-image:
  stage: build
  image:
    name: mkaczanowski/packer-builder-arm:latest
    entrypoint: [""]
  needs:
    - download-docker-images
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_COMMIT_TAG =~ /^v/'
  before_script:
    - mount binfmt_misc -t binfmt_misc /proc/sys/fs/binfmt_misc || true
    - |
      if [ ! -f /proc/sys/fs/binfmt_misc/qemu-aarch64 ]; then
        echo "ERROR: QEMU aarch64 binfmt not registered on host!"
        exit 1
      fi
      echo "QEMU aarch64 binfmt: OK"

    # Install tools for compression
    - apt-get update -qq
    - apt-get install -y -qq xz-utils zerofree e2fsprogs parted wget kpartx util-linux curl 2>&1 | tail -1

    # Download golden base image from Package Registry
    - echo "Downloading golden base image from Package Registry..."
    - |
      curl --fail --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           -o cubeos-base.img.xz \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cubeos-base/${BASE_VERSION}/${BASE_IMAGE_NAME}.img.xz"
    - ls -lh cubeos-base.img.xz
    - echo "Base image downloaded."
  script:
    # =====================================================================
    # Phase 1: Packer build (config only — packages already in base)
    # =====================================================================
    - echo "=== Building CubeOS ${CUBEOS_VERSION} from golden base ==="
    - chmod +x packer/scripts/*.sh firstboot/*.sh

    # Packer uses local base image
    - |
      packer build \
        -var "version=${CUBEOS_VERSION}" \
        -var "base_image_url=file:///build/cubeos-base.img.xz" \
        -var "base_image_checksum_type=none" \
        packer/cubeos.pkr.hcl
    - ls -lh ${IMAGE_NAME}.img
    - echo "=== Packer build complete ==="
    - echo ""

    # =====================================================================
    # Phase 2: Shrink + Compress
    # =====================================================================
    - echo "=== Compressing ${IMAGE_NAME}.img ==="

    # PiShrink
    - echo "[1/4] Running PiShrink..."
    - wget -q -O pishrink.sh https://raw.githubusercontent.com/Drewsif/PiShrink/master/pishrink.sh || echo "WARN PiShrink download failed, skipping"
    - |
      if [ -f pishrink.sh ]; then
        chmod +x pishrink.sh
        bash pishrink.sh -s ${IMAGE_NAME}.img || echo "WARN PiShrink failed (non-fatal)"
      fi

    # Zerofree
    - echo "[2/4] Running zerofree..."
    - |
      LOOPDEV=""
      cleanup_loop() {
        if [ -n "$LOOPDEV" ]; then
          losetup -d "$LOOPDEV" 2>/dev/null || true
        fi
      }
      trap cleanup_loop EXIT
      LOOPDEV=$(losetup -fP --show ${IMAGE_NAME}.img)
      echo "Loop device: $LOOPDEV"
      sleep 2
      ROOT_PART="${LOOPDEV}p2"
      if [ -b "$ROOT_PART" ]; then
        e2fsck -fy "$ROOT_PART" || true
        zerofree -v "$ROOT_PART" || echo "WARN zerofree failed (non-fatal)"
      fi
      losetup -d "$LOOPDEV"
      LOOPDEV=""

    # XZ compress
    - echo "[3/4] Compressing with xz -6 (multi-threaded)..."
    - ls -lh ${IMAGE_NAME}.img
    - xz -6 -T0 -v ${IMAGE_NAME}.img

    # Checksums
    - echo "[4/4] Calculating checksums..."
    - sha256sum ${IMAGE_NAME}.img.xz > ${IMAGE_NAME}.img.xz.sha256
    - md5sum ${IMAGE_NAME}.img.xz > ${IMAGE_NAME}.img.xz.md5

    # Summary
    - echo ""
    - echo "============================================================"
    - echo "  CubeOS Release Artifact"
    - echo "============================================================"
    - echo "  File     ${IMAGE_NAME}.img.xz"
    - echo "  Size     $(du -h ${IMAGE_NAME}.img.xz | cut -f1)"
    - echo "  SHA256   $(cut -d' ' -f1 ${IMAGE_NAME}.img.xz.sha256)"
    - echo "============================================================"
  artifacts:
    paths:
      - "${IMAGE_NAME}.img.xz"
      - "${IMAGE_NAME}.img.xz.sha256"
      - "${IMAGE_NAME}.img.xz.md5"
    expire_in: 30 days
  timeout: 60m

# =============================================================================
# Optional: Create GitLab Release (triggered by tag push only)
# =============================================================================
create-release:
  stage: .post
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - build-image
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v/'
  script:
    - echo "Creating release for ${CI_COMMIT_TAG}..."
    - CHECKSUM=$(cut -d' ' -f1 ${IMAGE_NAME}.img.xz.sha256)
    - echo "SHA256 ${CHECKSUM}"
  release:
    tag_name: "${CI_COMMIT_TAG}"
    name: "CubeOS ${CI_COMMIT_TAG}"
    description: |
      ## CubeOS ${CI_COMMIT_TAG}

      Flashable ARM64 image for Raspberry Pi 4/5 (Ubuntu 24.04.3 based).

      ### Quick Start
      1. Flash the .img.xz to SD card using Raspberry Pi Imager
      2. Boot the Pi
      3. Connect to WiFi AP (check console output for SSID and password)
      4. Open http://cubeos.cube in your browser
      5. Complete the setup wizard

      ### Default Credentials
      - Dashboard: admin / cubeos
      - SSH: key-only (configure in wizard)
    assets:
      links:
        - name: "${IMAGE_NAME}.img.xz"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cubeos/${CUBEOS_VERSION}/${IMAGE_NAME}.img.xz"
        - name: "SHA256 Checksum"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cubeos/${CUBEOS_VERSION}/${IMAGE_NAME}.img.xz.sha256"
