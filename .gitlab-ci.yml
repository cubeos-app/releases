# =============================================================================
# CubeOS Releases Pipeline - Packer Image Builder
# =============================================================================
#
# This pipeline builds flashable ARM64 images for Raspberry Pi.
# It clones the coreapps repo at build time so compose files in the image
# always match production.
#
# WARNING: deploy/restart/build-hal/package-hal jobs belong ONLY in the
# coreapps repo (cubeos/coreapps). NEVER add them here â€” the releases repo
# has no app directories, so cleanup logic would delete all Pi services.
#
stages:
  - image

variables:
  CUBEOS_VERSION: "0.1.0-alpha.6"

# =============================================================================
# BUILD IMAGE - Packer ARM64 image with coreapps bundle
# =============================================================================
# Trigger: Manual on main (Play button) or automatic on v* tag push
# Runner: GPU VM (nllei01gpu01) with packer-builder-arm
# =============================================================================
build-image:
  stage: image
  tags:
    - multiarch
  variables:
    PACKER_LOG: "1"
  before_script:
    - |
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "  CubeOS Image Builder â€” v${CUBEOS_VERSION}"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # â”€â”€ Clone coreapps repo and prepare bundle â”€â”€
      echo "ğŸ“¦ Cloning coreapps repo..."
      git clone --depth 1 \
        "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/cubeos/coreapps.git" \
        /tmp/coreapps-src

      # Services to bake into the image
      SERVICES="pihole npm cubeos-api cubeos-hal cubeos-dashboard dozzle ollama chromadb registry"

      echo "ğŸ“¦ Preparing coreapps bundle..."
      mkdir -p coreapps-bundle

      for svc in $SERVICES; do
        if [ -d "/tmp/coreapps-src/${svc}" ]; then
          mkdir -p "coreapps-bundle/${svc}"
          if [ -d "/tmp/coreapps-src/${svc}/appconfig" ]; then
            cp -r "/tmp/coreapps-src/${svc}/appconfig" "coreapps-bundle/${svc}/"
          fi
        else
          echo "  âš ï¸  Service ${svc} not found in coreapps repo"
        fi
      done

      # Copy scripts directory
      if [ -d "/tmp/coreapps-src/scripts" ]; then
        cp -r /tmp/coreapps-src/scripts coreapps-bundle/
        chmod +x coreapps-bundle/scripts/*.sh 2>/dev/null || true
      fi

      echo "ğŸ“¦ Coreapps bundle contents:"
      find coreapps-bundle -type f | sort
      rm -rf /tmp/coreapps-src

      # Ensure docker-images directory exists (may be empty)
      mkdir -p docker-images
  script:
    - |
      docker run --rm --privileged \
        -v /dev:/dev \
        -v "${PWD}:/build" \
        mkaczanowski/packer-builder-arm:latest \
        build \
        -var "version=${CUBEOS_VERSION}" \
        -var "base_image_url=file:///build/cubeos-base.img.xz" \
        /build/packer/cubeos.pkr.hcl

      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "  âœ… Image built: cubeos-${CUBEOS_VERSION}-arm64.img"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      ls -lh cubeos-*.img
  artifacts:
    paths:
      - "cubeos-*.img"
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG =~ /^v/
    - if: $CI_COMMIT_BRANCH == "main"


